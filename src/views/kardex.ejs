<!DOCTYPE html>
<html lang="en">

<head>
    <title>Kardex PEPS</title>
</head>

<script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>
<body>

    <%- include("partials/_headerpanel") %>
        <%- include("partials/_sidebarpanel") %>
            <main id="main" class="main">

                <div class="pagetitle">
                    <h1>Kardex PEPS</h1>
                    <nav>
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">Inicio</a></li>
                            <li class="breadcrumb-item">Reportes</li>
                            <li class="breadcrumb-item active">Kardex</li>
                        </ol>
                    </nav>
                </div>

                <section class="section">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-12">
                                            <select class="js-example-basic-single form-select" id="productos">
                                                <% if (productos) { %>
                                                    <% productos.forEach(row=> { %><option
                                                            value="<%= row.id_producto %>" }>
                                                            Codigo: <%= row.codigo %> | Nombre: <%= row.nombre %>
                                                        </option>
                                                        <% }); %>
                                                            <% } %>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="container-fluid mt-2">
                                        <div class="table-wrapper">
                                            <button class="btn btn-primary mb-2" onclick="ExportToExcel()"><i
                                                    class="bi bi-file-excel"></i>Exportar Excel</button>
                                            <button class="btn btn-danger mb-2" onclick="ExportToPDF()"><i
                                                    class="bi bi-file-pdf"></i>Exportar PDF</button>
                                            <table
                                                class="fl-table table table-sm table-hover text-center fl-table tablesort w-100"
                                                id="datatable">
                                                <thead>
                                                    <tr class="text-light" style="background-color: #59ab6e;">
                                                        <th colspan="2"></th>
                                                        <th colspan="3" class="text-light">ENTRADAS</th>
                                                        <th colspan="3" class="text-light">SALIDAS</th>
                                                        <th colspan="3" class="text-light">SALDOS</th>
                                                    </tr>
                                                    <tr class="text-light" style="background-color: #59ab6e;">
                                                        <th>FECHA</th>
                                                        <th>DETALLE</th>
                                                        <th>CANTIDAD</th>
                                                        <th>PRECIO</th>
                                                        <th>TOTAL</th>
                                                        <th>CANTIDAD</th>
                                                        <th>PRECIO</th>
                                                        <th>TOTAL</th>
                                                        <th>CANTIDAD</th>
                                                        <th>PRECIO</th>
                                                        <th>TOTAL</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>
            </main>
            <%- include("partials/_fotterpanel") %>
                <script>
                    $('.js-example-basic-single').select2({ theme: 'bootstrap-5' });
                    function ExportToExcel() {
                        var elt = document.getElementById('datatable');
                        var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
                        return XLSX.writeFile(wb, 'Kardex' + Date.now() + "." + 'xlsx');
                    }

                    function ExportToPDF() {
                        var doc = new jsPDF('l', 'pt', 'letter');
                        var htmlstring = '';
                        var tempVarToCheckPageHeight = 0;
                        var pageHeight = 0;
                        pageHeight = doc.internal.pageSize.height;
                        specialElementHandlers = {
                            '#bypassme': function (element, renderer) {
                                return true
                            }
                        };
                        var y = 20;
                        var date = new Date().toJSON().slice(0, 10).split('-').reverse().join('/')
                        doc.setLineWidth(2);
                        var text = "Consultagro  S.A \nDirección: Avenida Juan X Marcos & Olmedo, Babahoyo \nTeléfono: 05-2570884 \nCorreo: consultagro.cia@gmail.com";
                        var x = doc.internal.pageSize.getWidth() / 2;
                        doc.setFontSize(9);
                        doc.text(50, 20, text);
                        doc.setFontSize(16);
                        doc.text(x, 65, "Kardex PEPS");
                        doc.setFontSize(9);
                        doc.text(50, (doc.internal.pageSize.height - 25), ("Autor: <%= credentials.nombre %>" + " \nFecha: " + date));
                        var img = new Image()
                        img.src = 'img/logo.png'
                        doc.addImage(img, 'png', (doc.internal.pageSize.getWidth() - 100), 0, 60, 60);
                        doc.autoTable({
                            html: '#datatable',
                            theme: 'grid',
                            startY: y + 70,
                        })
                        doc.save(('Kardex' + Date.now() + "." + 'pdf'));
                    }
                    $(document).ready(function () {
                        var tabla = $('#datatable').DataTable({
                            ajax: {
                                url: '/obtener_kardex',
                                type: 'POST',
                                data: function (d) {
                                    d.id_producto = $("#productos").val()
                                },
                            },
                            columns: [
                                { data: 'fecha', defaultContent: "-" },
                                { data: 'detalle', defaultContent: "-" },
                                { data: 'ecantidad', defaultContent: "-" },
                                {
                                    data: 'eunidad',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                },
                                {
                                    data: 'etotal',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                },
                                { data: 'scantidad', defaultContent: "-" },
                                {
                                    data: 'sunidad',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                }, {
                                    data: 'stotal',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                },
                                { data: 'icantidad', defaultContent: "-" },
                                {
                                    data: 'iunidad',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                }, {
                                    data: 'itotal',
                                    render: function (data) {
                                        return (data !== null) ? "$" + data : "-";
                                    }
                                },
                            ],
                            columnDefs: [
                                {
                                    targets: "_all",
                                    className: "dt-center",
                                }
                            ],
                            "language": {
                                "sEmptyTable": "No hay datos disponibles en la tabla",
                                "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                                "sInfoEmpty": "Mostrando 0 a 0 de 0 entradas",
                                "sInfoFiltered": "(Filtrado de _MAX_ entradas totales)",
                                "sInfoPostFix": "",
                                "sInfoThousands": ",",
                                "sLengthMenu": "Mostrar _MENU_ entradas",
                                "sLoadingRecords": "Cargando...",
                                "sProcessing": "Procesando...",
                                "sSearch": "Buscar:",
                                "sZeroRecords": "No se encontraron resultados",
                                "oPaginate": {
                                    "sFirst": "Primero",
                                    "sLast": "Último",
                                    "sNext": "Siguiente",
                                    "sPrevious": "Anterior"
                                },
                                "oAria": {
                                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                                },
                                "buttons": {
                                    "copy": "Copiar",
                                    "colvis": "Visibilidad"
                                }
                            }
                        });
                        $("#datatable_filter").hide();
                        $('#search').keyup(function () {
                            table = $('.tablesort').DataTable();
                            table.search($(this).val()).draw();
                        });
                        $('#date').change(function () {
                            table = $('.tablesort').DataTable();
                            table.search($(this).val()).draw();
                        });
                        $('#actualizar').click(async function () {
                            await table.ajax.reload()
                        });
                        $('#productos').change(function () {
                            tabla.ajax.reload();
                        });
                    });

                </script>

</body>

</html>