<!DOCTYPE html>
<html lang="en">

<head>
    <title>Inventario</title>
</head>

<body>
    <%- include("partials/_headerpanel") %>
        <%- include("partials/_sidebarpanel") %>
            <main id="main" class="main">
                <div class="pagetitle">
                    <h1>Usuarios</h1>
                    <nav>
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">Inicio</a></li>
                            <li class="breadcrumb-item">Administrar</li>
                            <li class="breadcrumb-item active">Usuarios</li>
                        </ol>
                    </nav>
                </div>

                <section class="section">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-grid gap-2 d-md-block">
                                        <button class="btn btn-primary" type="button" onclick="add()"><i
                                                class="bi bi-plus"></i>Nuevo
                                            usuario</button>
                                    </div>
                                </div>
                                <div class="card-header">
                                    <div class="input-group mb-3">
                                        <form class="form-floating">
                                            <input type="text" class="form-control" id="search" placeholder="Buscar"
                                                value="">
                                            <label for="search">Buscar</label>
                                        </form>
                                        <span class="input-group-text" id="basic-addon1"><i
                                                class="bi bi-search"></i></span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="container-fluid mt-2">
                                        <div class="table-wrapper">
                                            <table
                                                class="fl-table table table-sm table-hover text-center tablesort w-100"
                                                id="datatable">
                                                <thead class="text-light" style="background-color: #59ab6e;">
                                                    <tr>
                                                        <th>Nombre completo</th>
                                                        <th>Usuario</th>
                                                        <th>Identificacion</th>
                                                        <th>Correo</th>
                                                        <th>Teléfono</th>
                                                        <th>Provincia</th>
                                                        <th>Ciudad</th>
                                                        <th>Dirección</th>
                                                        <th>Perfil</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
            <div class="modal fade" id="usuarioModal" tabindex="-1" aria-labelledby="usuarioModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="usuarioModalLabel"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="usuarioForm">
                                <div class="card mb-3 border-0">
                                    <div class="row g-0">
                                        <div class="col-md-12">
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <input type="text" class="form-control" id="nombre"
                                                                name="nombre" placeholder="Ingese su nombre" required>
                                                            <label for="nombre">Nombre Completo</label>
                                                        </div>
                                                    </div>
                                                    <div class=" col-12">
                                                        <div class="form-floating">
                                                            <input type="text" class="form-control" id="usuario"
                                                                name="usuario" placeholder="Ingese su nombre de usuario"
                                                                required>
                                                            <label for="usuario">Usuario</label>
                                                        </div>
                                                    </div>
                                                    <div class=" col-12">
                                                        <div class="form-floating">
                                                            <input type="number" class="form-control"
                                                                name="identificacion" id="identificacion"
                                                                placeholder="Ingese su número de Cédula/RUC" required>
                                                            <label for="identificacion">Cédula/RUC</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <input type="number" name="telefono" class="form-control"
                                                                id="telefono" placeholder="Ingese su telefono" required>
                                                            <label for="telefono">Telefono</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <input type="email" name="correo" class="form-control"
                                                                id="correo" placeholder="Ingese su correo" required>
                                                            <label for="correo">Correo</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <select name="provincias" class="form-select"
                                                                name="provincia_id" id="provincias">
                                                                <option selected disabled>Selecione una opción
                                                                </option>
                                                            </select>
                                                            <label for="provincias">Provincias</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <select name="ciudad_id" class="form-select" id="ciudades">
                                                                <option selected disabled>Selecione una opción</option>
                                                            </select>
                                                            <label for="ciudades">Ciudades</label>
                                                        </div>
                                                    </div>
                                                    <div class=" col-12">
                                                        <div class="form-floating">
                                                            <input type="text" class="form-control" id="direccion"
                                                                name="direccion" placeholder="Ingese su direccion"
                                                                required>
                                                            <label for="direccion">Dirección</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating">
                                                            <select name="perfil_id" class="form-select" id="perfiles">
                                                                <option selected disabled>Selecione una opción</option>
                                                            </select>
                                                            <label for="perfiles">Perfiles</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Eliminar Usuario</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">¿Estás seguro de que deseas eiminar este usuario?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <a class="btn btn-danger" href="">Eliminar</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="cambiarModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Cambiar Contaseña</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="cambiarForm">
                            <div class="modal-body"><label class="form-label" for="nueva_contrasena">Nueva
                                    contraseña</label><input class="form-control" type="password"
                                    name="nueva_contrasena" id="nueva_contrasena"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <%- include("partials/_fotterpanel") %>
                <script>
                    var op = '';
                    var id_usuario = '';
                    var provinciasSelect = document.getElementById("provincias");
                    var table;
                    $(document).ready(function () {

                        fetch("/obtener_provincias", {
                            method: "POST"
                        })
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (data) {
                                if (data.data !== null) {
                                    data.data.forEach(function (provincia) {
                                        var option = document.createElement("option");
                                        option.value = provincia.id_provincia;
                                        option.text = provincia.provincia;
                                        provinciasSelect.appendChild(option);
                                    });
                                }
                            })
                            .catch(function (error) {
                                console.error("Error:", error);
                            });
                        provinciasSelect.addEventListener("change", function () {
                            var provinciaId = this.value;
                            $("#ciudades").html('');
                            fetch("/obtener_ciudades", {
                                method: "POST",
                                body: JSON.stringify({ provinciaId: provinciaId }),
                                headers: {
                                    "Content-Type": "application/json"
                                }
                            })
                                .then(function (response) {
                                    return response.json();
                                })
                                .then(function (data) {
                                    if (data.data !== null) {
                                        $("#ciudades").html("<option value='' selected disabled>Selecciona una opción</option>");
                                        data.data.forEach(function (ciudad) {
                                            var option = document.createElement("option");
                                            option.value = ciudad.id_ciudad;
                                            option.text = ciudad.ciudad;
                                            $("#ciudades").append(option);
                                        });
                                    }
                                })
                                .catch(function (error) {
                                    console.error("Error:", error);
                                });
                        });
                        var perfilesSelect = document.getElementById("perfiles");
                        fetch("/obtener_perfiles", {
                            method: "POST"
                        })
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (data) {
                                if (data.data !== null) {
                                    data.data.forEach(function (provincia) {
                                        var option = document.createElement("option");
                                        option.value = provincia.id_perfil;
                                        option.text = provincia.perfil;
                                        perfilesSelect.appendChild(option);
                                    });
                                }
                            })
                            .catch(function (error) {
                                console.error("Error:", error);
                            });

                        table = $('#datatable').DataTable({
                            ajax: {
                                url: "/obtener_usuarios",
                                "type": "POST",
                                "dataSrc": "data",
                            },
                            bLengthChange: false,
                            info: true,
                            paging: true, columns: [
                                { data: "nombre", defaultContent: "-" },
                                { data: "usuario", defaultContent: "-" },
                                { data: "identificacion", defaultContent: "-" },
                                { data: "correo", defaultContent: "-" },
                                { data: "telefono", defaultContent: "-" },
                                { data: "provincia", defaultContent: "-" },
                                { data: "ciudad", defaultContent: "-" },
                                { data: "direccion", defaultContent: "-" },
                                { data: "perfil", defaultContent: "-" },
                            ],
                            columnDefs: [
                                {
                                    targets: "_all",
                                    className: "dt-center",
                                },
                                {
                                    targets: 9,
                                    render: function (data, type, row, meta) {
                                        var data = table.row(meta.row).data();
                                        var dataAsString = JSON.stringify(data);
                                        return `<div class="d-flex flex-row mb-3"><button type="button" class="btn btn-primary btn-sm m-1" data-id="${data.id_usuario}" data-nombre="${data.nombre ?? ""}" data-usuario="${data.usuario ?? ''}" data-identificacion="${data.identificacion ?? ''}" data-telefono="${data.telefono ?? ''}" data-correo="${data.correo ?? ''}" data-direccion="${data.direccion ?? ''}" data-perfil="${data.perfil_id ?? ''}" data-provincia="${data.provincia_id ?? ''}" data-ciudad="${data.id_ciudad ?? ''}" onclick="edit(this)" title="Editar"><i class="bi bi-pencil-square"></i></i></button><button type="button" class="btn btn-warning text-light btn-sm m-1" data-id="${data.id_usuario}" onclick="cambiar(this)"> <i class="bi bi-key"></i></button></div>`;
                                    }
                                }
                            ],
                            "language": {
                                "sEmptyTable": "No hay datos disponibles en la tabla",
                                "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                                "sInfoEmpty": "Mostrando 0 a 0 de 0 entradas",
                                "sInfoFiltered": "(Filtrado de _MAX_ entradas totales)",
                                "sInfoPostFix": "",
                                "sInfoThousands": ",",
                                "sLengthMenu": "Mostrar _MENU_ entradas",
                                "sLoadingRecords": "Cargando...",
                                "sProcessing": "Procesando...",
                                "sSearch": "Buscar:",
                                "sZeroRecords": "No se encontraron resultados",
                                "oPaginate": {
                                    "sFirst": "Primero",
                                    "sLast": "Último",
                                    "sNext": "Siguiente",
                                    "sPrevious": "Anterior"
                                },
                                "oAria": {
                                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                                },
                                "buttons": {
                                    "copy": "Copiar",
                                    "colvis": "Visibilidad"
                                }
                            }
                        });
                        $("#datatable_filter").hide();
                        $('#search').keyup(function () {
                            table = $('.tablesort').DataTable();
                            table.search($(this).val()).draw();
                        });
                        $('#actualizar').click(async function () {
                            await table.ajax.reload()
                        });
                    });
                    function cambiar(button) {
                        $("#cambiarForm")[0].reset();
                        id_usuario = button.getAttribute('data-id')
                        $('#cambiarModal').modal('show');
                    };
                    function edit(button) {
                        $("#usuarioModalLabel").text("Editar Usuario");
                        $("#usuarioForm")[0].reset();
                        var nombre = button.getAttribute('data-nombre');
                        var usuario = button.getAttribute('data-usuario');
                        var identificacion = button.getAttribute('data-identificacion');
                        var telefono = button.getAttribute('data-telefono');
                        var correo = button.getAttribute('data-correo');
                        var direccion = button.getAttribute('data-direccion');
                        var perfil = button.getAttribute('data-perfil');
                        var provincia = button.getAttribute('data-provincia');
                        var ciudad = button.getAttribute('data-ciudad');
                        id_usuario = button.getAttribute('data-id')
                        $("#nombre").val(nombre);
                        $("#usuario").val(usuario);
                        $("#identificacion").val(identificacion);
                        $("#telefono").val(telefono);
                        $("#correo").val(correo);
                        $("#direccion").val(direccion);
                        $('#provincias option[value="' + provincia + '"]').prop('selected', true);
                        $('#perfiles option[value="' + perfil + '"]').prop('selected', true);
                        fetch("/obtener_ciudades", {
                            method: "POST",
                            body: JSON.stringify({ provinciaId: provincia }),
                            headers: {
                                "Content-Type": "application/json"
                            }
                        })
                            .then(function (response) {
                                return response.json();
                            })
                            .then(function (data) {
                                $("#ciudades").html('');
                                if (data.data !== null) {
                                    $("#ciudades").html("<option value='' selected disabled>Selecciona una opción</option>");
                                    data.data.forEach(function (ciudad) {
                                        var option = document.createElement("option");
                                        option.value = ciudad.id_ciudad;
                                        option.text = ciudad.ciudad;
                                        $("#ciudades").append(option);
                                    });
                                    $('#ciudades option[value="' + ciudad + '"]').prop('selected', true);
                                }
                            })
                            .catch(function (error) {
                                console.error("Error:", error);
                            });
                        op = '/update_usuario';
                        $('#usuarioModal').modal('show');
                    }

                    function add() {
                        $("#usuarioForm")[0].reset();
                        $("#usuarioModalLabel").text("Nuevo Usuario");
                        $('#usuarioModal').modal('show');
                        id_usuario = '';
                        op = '/insertar_usuario';
                    }

                    $('#usuarioForm').submit(async function (e) {
                        e.preventDefault();
                        const formData = new FormData(event.target);
                        formData.append('id_usuario', id_usuario);
                        const response = await fetch(op, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.message) {
                            Swal.fire({
                                toast: true,
                                position: 'bottom-end',
                                icon: 'success',
                                title: data.message,
                                showConfirmButton: false,
                                timerProgressBar: true,
                                timer: 3000
                            });
                            table.ajax.reload();
                            $("#usuarioForm")[0].reset();
                            $('#usuarioModal').modal('hide');
                        } else if (data.error) {
                            Swal.fire({
                                toast: true,
                                position: 'bottom-end',
                                icon: 'error',
                                title: data.error,
                                showConfirmButton: false,
                                timerProgressBar: true,
                                timer: 3000
                            });
                        }
                    });

                    $('#cambiarForm').submit(async function (e) {
                        e.preventDefault();
                        const formData = new FormData(event.target);
                        formData.append('id_usuario', id_usuario);
                        const response = await fetch('/cambiar_contrasena', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.message) {
                            Swal.fire({
                                toast: true,
                                position: 'bottom-end',
                                icon: 'success',
                                title: data.message,
                                showConfirmButton: false,
                                timerProgressBar: true,
                                timer: 3000
                            });
                            $('#cambiarModal').modal('hide');
                            $("#cambiarForm")[0].reset();
                        } else if (data.error) {
                            Swal.fire({
                                toast: true,
                                position: 'bottom-end',
                                icon: 'error',
                                title: data.error,
                                showConfirmButton: false,
                                timerProgressBar: true,
                                timer: 3000
                            });
                        }
                    });
                </script>

</body>

</html>