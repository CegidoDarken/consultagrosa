<!DOCTYPE html>
<html lang="en">

<head>
    <title>Inventario</title>
</head>

<body>
    <%- include("partials/_headerpanel") %>
        <%- include("partials/_sidebarpanel") %>
            <main id="main" class="main">

                <div class="pagetitle">
                    <h1>Productos</h1>
                    <nav>
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/admin">Inicio</a></li>
                            <li class="breadcrumb-item">Inventario</li>
                            <li class="breadcrumb-item active">Productos</li>
                        </ol>
                    </nav>
                </div>

                <section class="section">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-grid gap-2 d-md-block">
                                        <button class="btn btn-primary" type="button" onclick="nuevo(this)"><i
                                                class="bi bi-plus"></i>Nuevo producto</button>
                                    </div>
                                </div>
                                <div class="card-header row">
                                    <div class="col-md-3">
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="search" placeholder="Buscar"
                                                value="">
                                            <span class="input-group-text" id="basic-addon1"><i
                                                    class="bi bi-search"></i></span>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group mb-3">
                                            <input type="date" class="form-control" id="date" value="">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="container-fluid mt-2">
                                        <div class="table-wrapper">
                                            <table
                                                class="fl-table table table-sm table-hover text-center tablesort w-100"
                                                id="datatable">
                                                <thead class="text-light" style="background-color: #59ab6e;">
                                                    <tr>
                                                        <th>Imagen</th>
                                                        <th>Código</th>
                                                        <th>Nombre</th>
                                                        <th>Categoría</th>
                                                        <th>Tag</th>
                                                        <th>Medidas</th>
                                                        <th>Precio</th>
                                                        <th>Cantidad</th>
                                                        <th>Total</th>
                                                        <th>Fecha</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>
            </main>

            <div class="modal fade" id="producto" tabindex="-1" aria-labelledby="productoLabel" arhide="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="titulo"></h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="productoForm">
                                <div class="card mb-3 border-0">
                                    <div class="row g-0">
                                        <div class="col-md-4">
                                            <img src="img/no-image-icon.png" id="img" style="width: 100%;
                                            height: 300px;
                                            object-fit: contain;
                                            object-position: center;" class="mb-3">
                                            <div class="mb-3">
                                                <input class="form-control form-control-sm" id="image" type="file"
                                                    accept="image/*">
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <div class="form-floating mb-3">
                                                            <input type="text" class="form-control" id="codigo"
                                                                name="codigo" placeholder="Ingrese un código" required>
                                                            <label for="codigo">Código</label>
                                                        </div>
                                                    </div>
                                                    <div class=" col-8 text-start">
                                                        <div class="form-floating mb-3">
                                                            <input type="number" class="form-control" id="tag"
                                                                name="tag" placeholder="Ingrese un tag"
                                                                max="9999999999">
                                                            <label for="tag">Tag</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <button class="btn btn-primary control mt-2" type="button"
                                                            onclick="asignar_tag()">Generar</button>
                                                    </div>
                                                    <div class=" col-12 text-start">
                                                        <div class="form-floating mb-3">
                                                            <input type="text" class="form-control" id="nombre"
                                                                name="nombre"
                                                                placeholder="Ingrese un nombre de producto" required>
                                                            <label for="nombre">Nombre</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating mb-3">
                                                            <select name="categoria" class="form-select" id="categorias"
                                                                required>
                                                                <option value="" selected disabled>Selecciona una opción
                                                                </option>
                                                                <% if (categorias) { %>
                                                                    <% categorias.forEach(row=> { %><option
                                                                            value="<%= row.id_categoria %>" }>
                                                                            <%= row.categoria %>
                                                                        </option>
                                                                        <% }); %>
                                                                            <% } %>
                                                            </select>
                                                            <label for="floatingSelect">Categorías</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-floating mb-3">
                                                            <select name="medida" class="form-select" id="medidas"
                                                                required>
                                                                <option value="" selected disabled>Selecciona una opción
                                                                </option>
                                                                <optgroup label="Litros">
                                                                    <option value="1L">1 Litro</option>
                                                                    <option value="5L">5 Litros</option>
                                                                    <option value="20L">20 Litros</option>
                                                                    <option value="25L">25 Litros</option>
                                                                </optgroup>
                                                                <optgroup label="Kilogramos">
                                                                    <option value="1Kg">1 Kilogramo</option>
                                                                    <option value="5Kg">5 Kilogramos</option>
                                                                    <option value="20Kg">20 Kilogramos</option>
                                                                    <option value="25Kg">25 Kilogramos</option>
                                                                </optgroup>
                                                            </select>
                                                            <label for="floatingSelect">Medidas</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <textarea id="descripcion" class="form-control mb-3"
                                                            placeholder="Descripción" name="descripcion"
                                                            style="max-height: 150px;min-height: 150px;"></textarea>
                                                    </div>
                                                    <div class=" col-md-6 text-start">
                                                        <div class="form-floating mb-3">
                                                            <input type="number" class="form-control" id="cantidad"
                                                                name="cantidad" placeholder="Ingrese una cantidad"
                                                                oninput="calculartotal()" required>
                                                            <label for="cantidad">Cantidad</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 text-start">
                                                        <div class="form-floating mb-3">
                                                            <input type="number" class="form-control" id="precio"
                                                                name="precio" placeholder="Ingrese un precio"
                                                                oninput="calculartotal()" step="any" required>
                                                            <label for="precio">Precio</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12 text-start">
                                                        <div class="form-floating mb-3">
                                                            <input type="number" class="form-control" id="total"
                                                                name="total" placeholder="Total" readonly>
                                                            <label for="total">Total</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar cambios</button>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="delete_producto" tabindex="-1" aria-labelledby="exampleModalLabel"
                arhide="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Eliminar producto</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">¿Estás seguro de que deseas eiminar este producto?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button class="btn btn-danger" id="eliminar">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
            <%- include("partials/_fotterpanel") %>
                <script>
                    var id;
                    var op;
                    var table = $('#datatable').DataTable({
                        ajax: {
                            url: "/obtener_inventario",
                            type: "POST",
                            dataSrc: "data",
                        },
                        bLengthChange: false,
                        info: true,
                        paging: true, columns: [
                            { data: "img" },
                            { data: "codigo", defaultContent: "-" },
                            { data: "nombre", defaultContent: "-" },
                            { data: "categoria", defaultContent: "-" },
                            { data: "tag", defaultContent: "-" },
                            { data: "medida", defaultContent: "-" },
                            { data: "precio", defaultContent: "-" },
                            { data: "cantidad", defaultContent: "-" },
                            { data: "total", defaultContent: "-" },
                            { data: "fecha", defaultContent: "-" }
                        ],
                        columnDefs: [
                            {
                                targets: "_all",
                                className: "dt-center",
                            },
                            {
                                targets: 0,
                                render: function (data, type, row, meta) {
                                    var data = table.row(meta.row).data();
                                    return (data.img) ? `<button data-img="${data.img}" data-nombre="${data.nombre}" class="btn btn-primary btn-sm m-1" onclick="view_img(this)" ><i class="bi bi-eye-fill"></i></button>` : "-";
                                }
                            },
                            {
                                targets: 4,
                                render: function (data, type, row, meta) {
                                    var data = table.row(meta.row).data();
                                    if (data.tag) {
                                        return `<span class="badge rounded-pill text-bg-primary text-light">#${data.tag}</span>`;
                                    } else {
                                        return `<span class="badge rounded-pill text-bg-warning text-light border-0">Sin asignar</span>`;
                                    }
                                }
                            },
                            {
                                targets: 6,
                                render: function (data, type, row, meta) {
                                    var data = table.row(meta.row).data();
                                    return "$" + data.precio;
                                }
                            },
                            {
                                targets: 8,
                                render: function (data, type, row, meta) {
                                    var data = table.row(meta.row).data();
                                    return "$" + data.total;
                                }
                            },
                            {
                                targets: 10,
                                render: function (data, type, row, meta) {
                                    var data = table.row(meta.row).data();
                                    var dataAsString = JSON.stringify(data);
                                    return `<div class="d-flex flex-row mb-3"><center><button type="button" class="btn btn-primary btn-sm m-1" data-id="${data.id_producto}" data-img="${data.img ?? 'img/no-image-icon.png'}" data-codigo="${data.codigo}" data-nombre="${data.nombre}" data-tag="${data.tag}" data-tag="${data.tag}" data-descripcion="${data.descripcion}" data-cantidad="${data.cantidad}" data-descuento="${data.descuento}" data-precio="${data.precio}" data-preciodesc="${data.preciodesc}" data-medida="${data.medida}" data-tag="${data.tag}" data-total="${data.total}" data-categoria="${data.categoria_id}" onclick="update_producto(this)" title="Editar"><i class="bi bi-pencil-square"></i></i></button><button type="button" class="btn btn-danger btn-sm m-1" data-id="${data.id_producto}" title="Eliminar" onclick="delete_producto(this)"><i class="bi bi-trash"></i></button></center></div>`;
                                }
                            }
                        ],
                        "language": {
                            "sEmptyTable": "No hay datos disponibles en la tabla",
                            "sInfo": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                            "sInfoEmpty": "Mostrando 0 a 0 de 0 entradas",
                            "sInfoFiltered": "(Filtrado de _MAX_ entradas totales)",
                            "sInfoPostFix": "",
                            "sInfoThousands": ",",
                            "sLengthMenu": "Mostrar _MENU_ entradas",
                            "sLoadingRecords": "Cargando...",
                            "sProcessing": "Procesando...",
                            "sSearch": "Buscar:",
                            "sZeroRecords": "No se encontraron resultados",
                            "oPaginate": {
                                "sFirst": "Primero",
                                "sLast": "Último",
                                "sNext": "Siguiente",
                                "sPrevious": "Anterior"
                            },
                            "oAria": {
                                "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                            },
                            "buttons": {
                                "copy": "Copiar",
                                "colvis": "Visibilidad"
                            }
                        }
                    });
                    $("#datatable_filter").hide();
                    $('#search').keyup(function () {
                        table = $('.tablesort').DataTable();
                        table.search($(this).val()).draw();
                    });
                    $('#actualizar').click(async function () {
                        await table.ajax.reload()
                    });

                    function delete_producto(button) {
                        id = button.getAttribute('data-id');
                        $("#delete_producto").modal('show');
                    }
                    function view_img(button) {
                        Swal.fire({
                            title: button.getAttribute('data-nombre'),
                            html: `<img class="card-img rounded-3 img-fluid border-0" src="${button.getAttribute('data-img')}" style=" width: 100%; height: 300px; object-fit: contain;object-position: center;">`,
                            showConfirmButton: false,
                        })
                    }
                    function update_producto(button) {
                        op = "update_producto";
                        id = button.getAttribute('data-id')
                        var img = button.getAttribute('data-img');
                        var codigo = button.getAttribute('data-codigo');
                        var tag = button.getAttribute('data-tag');
                        var nombre = button.getAttribute('data-nombre');
                        var descripcion = button.getAttribute('data-descripcion');
                        var cantidad = button.getAttribute('data-cantidad');
                        var categoria = button.getAttribute('data-categoria');
                        var precio = button.getAttribute('data-precio');
                        var total = button.getAttribute('data-total');
                        var medida = button.getAttribute('data-medida');
                        $("#titulo").text("Editar Producto");
                        $("#productoForm")[0].reset();
                        $('#img').attr('src', img);
                        $("#codigo").val(codigo);
                        $("#tag").val(tag);
                        $("#nombre").val(nombre);
                        $("#descripcion").val(descripcion);
                        $("#cantidad").val(cantidad);
                        $("#precio").val(precio);
                        $("#total").val(total);
                        $('#categorias option[value="' + categoria + '"]').prop('selected', true);
                        $('#medidas option[value="' + medida + '"]').prop('selected', true);
                        $('#producto').modal('show');
                    }
                    function nuevo(button) {
                        op = "insertar_producto";
                        $('input[name="1l"], input[name="5l"], input[name="20l"], input[name="1kg"], input[name="5kg"], input[name="25kg"]').prop('disabled', false);
                        $('#img').attr('src', "img/no-image-icon.png");
                        $("#titulo").text("Nuevo Producto");
                        $("#productoForm")[0].reset();
                        $('#producto').modal('show');
                    }
                    async function asignar_tag() {
                        var tag = generarTagUnico();
                        document.getElementById("tag").value = tag;
                        function generarTagUnico() {
                            var caracteres = "0123456789";
                            var longitud = 10;
                            return generarTagAleatorio(caracteres, longitud);
                        }

                        function generarTagAleatorio(caracteres, longitud) {
                            var tag = "";
                            for (var i = 0; i < longitud; i++) {
                                var indiceAleatorio = Math.floor(Math.random() * caracteres.length);
                                tag += caracteres.charAt(indiceAleatorio);
                            }
                            return tag;
                        }
                    }

                    function calculartotal() {
                        var cantidad = $('#cantidad').val();
                        var precio = $('#precio').val();
                        $('#total').val(parseFloat(cantidad * precio).toFixed(2));
                    }
                    function limit(input) {
                        if (input.id === "descuento") {
                            input.value = input.value.replace(/^0+/, '');
                            if (input.value === '') {
                                input.value = 0;
                            }
                            if (input.value > 100) {
                                input.value = 100;
                            }
                        } else if (input.id === "cantidad") {
                            input.value = input.value.replace(/^0+/, '');
                            if (input.value === '') {
                                input.value = 0;
                            }
                        }
                    }
                    document.getElementById('eliminar').addEventListener('click', function (event) {
                        fetch("delete_producto", {
                            method: 'POST',
                            body: JSON.stringify({ idproducto: id }),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(response => response.json()).then(data => {
                            if (data.message === "Success") {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'success',
                                    title: 'Eliminado exitosamente',
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                                $("#delete_producto").modal('hide');
                                table.ajax.reload();
                            } else {
                                Swal.fire({
                                    toast: true,
                                    position: 'top-end',
                                    icon: 'error',
                                    title: 'Error',
                                    text: data.message,
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                                $("#delete_producto").modal('hide');
                            }
                        }).catch(error => {
                            console.error(error);
                        });
                    });
                    document.getElementById('image').addEventListener('change', function (event) {
                        var output = document.getElementById('img');
                        const fileInput = document.getElementById('image');
                        output.src = URL.createObjectURL(fileInput.files[0]);
                        output.onload = function () {
                            URL.revokeObjectURL(output.src);
                        }
                    });
                    document.getElementById('productoForm').addEventListener('submit', async function (event) {
                        event.preventDefault();
                        const fileInput = document.getElementById('image');
                        const file = fileInput.files[0];
                        const formData = new FormData(event.target);
                        if (file) {
                            var maxSizeInBytes = 1024 * 1024; // 1 MB
                            var allowedType = 'image/png';
                            if (file.type !== allowedType) {
                                Swal.fire({
                                    toast: true,
                                    position: 'bottom-end',
                                    icon: 'error',
                                    title: "Solo se permiten archivos PNG.",
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                                return;
                            }
                            if (file.size > maxSizeInBytes) {
                                Swal.fire({
                                    toast: true,
                                    position: 'bottom-end',
                                    icon: 'error',
                                    title: "El tamaño del archivo debe ser menor o igual a 1 MB.",
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                                return;
                            }
                            const reader = new FileReader();
                            await new Promise((resolve) => {
                                reader.onloadend = function () {
                                    formData.append('img', reader.result);
                                    resolve();
                                };
                                reader.readAsDataURL(file);
                            });
                        }
                        formData.append('id_producto', id);
                        try {
                            const response = await fetch(op, {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();

                            if (data.message) {
                                Swal.fire({
                                    toast: true,
                                    position: 'bottom-end',
                                    icon: 'success',
                                    title: data.message,
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                                table.ajax.reload();
                                $('#producto').modal('hide');
                            } else if (data.error) {
                                Swal.fire({
                                    toast: true,
                                    position: 'bottom-end',
                                    icon: 'error',
                                    title: data.error,
                                    showConfirmButton: false,
                                    timerProgressBar: true,
                                    timer: 3000
                                });
                            }
                        } catch (error) {
                            console.error(error);
                        }
                    });
                </script>

</body>

</html>